<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    <link rel="canonical" href="https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/">
    
    
    <title>VPS搭建Shadowsocks服务和优化笔记 | 平方君的后花园 | Keep It Simple, Stupid.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="VPS,Shadowsocks">
    <meta name="description" content="前言由于最近开始上Github较多，无意中发现Github推出了一个学生开发者优惠大礼包，这对于囊中羞涩的学生来说真的是大大的福利，给Github一个大大的赞！
这个优惠包里头包含很多开发者需要付费购买的服务或者工具的优惠券，其中有一个DigitalOcean的$50优惠券，对于一直想入一台VPS但又因为价格昂贵望而却步的我来说就是雪中送炭啊，于是我马上注册获取优惠券，随即开始折腾，这里把这两天折">
<meta property="og:type" content="article">
<meta property="og:title" content="VPS搭建Shadowsocks服务和优化笔记">
<meta property="og:url" content="https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/index.html">
<meta property="og:site_name" content="平方君的后花园">
<meta property="og:description" content="前言由于最近开始上Github较多，无意中发现Github推出了一个学生开发者优惠大礼包，这对于囊中羞涩的学生来说真的是大大的福利，给Github一个大大的赞！
这个优惠包里头包含很多开发者需要付费购买的服务或者工具的优惠券，其中有一个DigitalOcean的$50优惠券，对于一直想入一台VPS但又因为价格昂贵望而却步的我来说就是雪中送炭啊，于是我马上注册获取优惠券，随即开始折腾，这里把这两天折">
<meta property="og:updated_time" content="2017-03-03T03:11:48.058Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="VPS搭建Shadowsocks服务和优化笔记">
<meta name="twitter:description" content="前言由于最近开始上Github较多，无意中发现Github推出了一个学生开发者优惠大礼包，这对于囊中羞涩的学生来说真的是大大的福利，给Github一个大大的赞！
这个优惠包里头包含很多开发者需要付费购买的服务或者工具的优惠券，其中有一个DigitalOcean的$50优惠券，对于一直想入一台VPS但又因为价格昂贵望而却步的我来说就是雪中送炭啊，于是我马上注册获取优惠券，随即开始折腾，这里把这两天折">
    
        <link rel="alternate" type="application/atom+xml" title="平方君的后花园" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">平方君</h5>
          <a href="mailto:i_square@qq.com" title="i_square@qq.com" class="mail">i_square@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页 | Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档 | archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签 | tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类 | Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-info-circle"></i>
                关于 | About
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/i-square" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/love" target="_blank" >
                <i class="icon icon-lg icon-heart"></i>
                Love Story
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">VPS搭建Shadowsocks服务和优化笔记</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">VPS搭建Shadowsocks服务和优化笔记</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-02-28T03:43:59.000Z" itemprop="datePublished" class="page-time">
  2017-02-28
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/笔记/">笔记</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前期准备"><span class="post-toc-number">2.</span> <span class="post-toc-text">前期准备</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Shadowsocks配置"><span class="post-toc-number">3.</span> <span class="post-toc-text">Shadowsocks配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#安装shadowsocks服务"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">安装shadowsocks服务</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#配置shadowsocks服务"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">配置shadowsocks服务</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Supervisor监控进程"><span class="post-toc-number">4.</span> <span class="post-toc-text">Supervisor监控进程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#安装supervisor"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">安装supervisor</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#配置supervisor"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">配置supervisor</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#supervisor开机自启"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">supervisor开机自启</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Shadowsocks服务优化"><span class="post-toc-number">5.</span> <span class="post-toc-text">Shadowsocks服务优化</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#系统层面"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">系统层面</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#优化内核参数"><span class="post-toc-number">5.1.1.</span> <span class="post-toc-text">优化内核参数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#TCP优化"><span class="post-toc-number">5.1.2.</span> <span class="post-toc-text">TCP优化</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#开启TCP-Fast-Open"><span class="post-toc-number">5.1.3.</span> <span class="post-toc-text">开启TCP Fast Open</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#开启TCP-BBR拥塞控制算法"><span class="post-toc-number">5.1.4.</span> <span class="post-toc-text">开启TCP BBR拥塞控制算法</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#加密层面"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">加密层面</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#安装M2Crypto"><span class="post-toc-number">5.2.1.</span> <span class="post-toc-text">安装M2Crypto</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-安装-gevent"><span class="post-toc-number">5.2.2.</span> <span class="post-toc-text">2.2 安装 gevent</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用CHACHA20加密算法"><span class="post-toc-number">5.2.3.</span> <span class="post-toc-text">使用CHACHA20加密算法</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#网络层面"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">网络层面</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#防火墙设置（如有）"><span class="post-toc-number">5.3.1.</span> <span class="post-toc-text">防火墙设置（如有）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#结语"><span class="post-toc-number">6.</span> <span class="post-toc-text">结语</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-VPS搭建Shadowsocks服务和优化笔记"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">VPS搭建Shadowsocks服务和优化笔记</h1>
        <div class="post-meta">
            <time class="post-time" title="2017-02-28 11:43:59" datetime="2017-02-28T03:43:59.000Z"  itemprop="datePublished">2017-02-28</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/笔记/">笔记</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于最近开始上Github较多，无意中发现Github推出了一个<a href="https://education.github.com/pack" target="_blank" rel="external">学生开发者优惠大礼包</a>，这对于囊中羞涩的学生来说真的是大大的福利，给Github一个大大的赞！</p>
<p>这个优惠包里头包含很多开发者需要付费购买的服务或者工具的优惠券，其中有一个<a href="https://www.digitalocean.com/" target="_blank" rel="external">DigitalOcean</a>的$50优惠券，对于一直想入一台VPS但又因为价格昂贵望而却步的我来说就是雪中送炭啊，于是我马上注册获取优惠券，随即开始折腾，这里把这两天折腾的过程记录一下。</p>
<a id="more"></a>
<h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><ul>
<li>一台运行CentOS 7 x64系统的主机</li>
<li><a href="http://www.putty.org/" target="_blank" rel="external">PuTTY</a>，Windows系统下登录远程主机的工具，一定要去官网下载，一些所谓的汉化版会夹带私货</li>
<li><a href="https://winscp.net/eng/download.php" target="_blank" rel="external">winSCP</a>，Windows系统下管理远程主机文件的工具，也去官网下载</li>
</ul>
<p>说明：VPS是必不可少的，(附<a href="https://www.digitalocean.com/?refcode=ef0a405dfe82" target="_blank" rel="external">我的digitalocean推介码</a>，注册即可获赠$10)，PuTTY用来在Windows系统下远程登录VPS，winSCP会用来下载密钥。</p>
<h2 id="Shadowsocks配置"><a href="#Shadowsocks配置" class="headerlink" title="Shadowsocks配置"></a>Shadowsocks配置</h2><p>首先使用PuTTY登录到你的VPS，方法就不赘述了，登录后切换到root账户。</p>
<h3 id="安装shadowsocks服务"><a href="#安装shadowsocks服务" class="headerlink" title="安装shadowsocks服务"></a>安装shadowsocks服务</h3><p>一步一步执行以下命令，可以复制后在PuTTY中点击鼠标右键粘贴，回车执行，如询问(Y/N)，则输入Y回车。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum install epel-release</div><div class="line">yum update</div><div class="line">yum install python-setuptools</div><div class="line">easy_install pip</div><div class="line">pip install shadowsocks</div></pre></td></tr></table></figure>
<p>以上命令执行完之后，shadowsocks已安装到你的VPS中，但还没有运行。</p>
<h3 id="配置shadowsocks服务"><a href="#配置shadowsocks服务" class="headerlink" title="配置shadowsocks服务"></a>配置shadowsocks服务</h3><p>运行shadowsocks需要一个配置文件，我们在/etc目录下新建一个配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/shadowsocks.json</div></pre></td></tr></table></figure>
<p>按键盘i建进入编辑模式，复制以下内容，然后直接右键粘贴。请改“端口号”为你需要的端口号，范围1 ~ 65535，改“你的密码”为你自己的密码。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"server"</span>:<span class="string">"0.0.0.0"</span>,</div><div class="line">    <span class="attr">"server_port"</span>:端口号,</div><div class="line">    <span class="attr">"local_address"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="attr">"local_port"</span>:<span class="number">1080</span>,</div><div class="line">    <span class="attr">"password"</span>:<span class="string">"你的密码"</span>,</div><div class="line">    <span class="attr">"timeout"</span>:<span class="number">500</span>,</div><div class="line">    <span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span>,</div><div class="line">    <span class="attr">"fast_open"</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>粘贴后，按键盘Esc键退出编辑模式，输入:wq回车，保存并退出。<br>上面这些参数应该不用多说了，用shadowsocks的都懂的。<br>最后一项<code>fast_open</code>表示是否使用<code>TCP_FASTOPEN</code>（后面优化部分会打开系统的TCP_FASTOPEN，所以这里填true,否则填false)</p>
<h2 id="Supervisor监控进程"><a href="#Supervisor监控进程" class="headerlink" title="Supervisor监控进程"></a>Supervisor监控进程</h2><p>配置好shadowsocks之后我们需要后台自启动服务，虽然目前shadowsocks自己也可以后台运行，但是如果有一个监控进程能在shadowsocks进程挂了之后重新启动它就更好了，supervisor就是用来监控进程的工具。</p>
<h3 id="安装supervisor"><a href="#安装supervisor" class="headerlink" title="安装supervisor"></a>安装supervisor</h3><p>运行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-setuptools supervisor</div><div class="line">easy_install supervisor</div></pre></td></tr></table></figure>
<h3 id="配置supervisor"><a href="#配置supervisor" class="headerlink" title="配置supervisor"></a>配置supervisor</h3><p>以上命令执行完之后，supervisor已经安装，然后我们编辑/etc/supervisord.conf文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>按键盘i建进入编辑模式，光标移到底部空行处，如没空行就在末尾回车加入空行，复制以下内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="section">[program:shadowsocks]</span></div><div class="line"><span class="attr">command</span>=ssserver -c /etc/shadowsocks.json</div><div class="line"><span class="attr">autostart</span>=<span class="literal">true</span></div><div class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></div><div class="line"><span class="attr">restartretries</span>=<span class="number">10</span></div><div class="line"><span class="attr">user</span>=nobody</div></pre></td></tr></table></figure>
<p>复制完成后，回个车，为底部再留下空行，按键盘Esc键退出编辑模式，输入:wq回车，保存并退出。这样就完成了supervisor监控shadowsocks进程的配置，接下来需要让supervisor开机启动，这样才能达到我们的目的。</p>
<h3 id="supervisor开机自启"><a href="#supervisor开机自启" class="headerlink" title="supervisor开机自启"></a>supervisor开机自启</h3><p>所幸，CentOS 7下supervisor开机启动非常的容易，<a href="https://github.com/Supervisor/initscripts" target="_blank" rel="external">User-contributed OS init scripts for Supervisor</a>，这个Github项目提供各个系统下的supervisor服务开机启动脚本，其中<a href="https://raw.githubusercontent.com/Supervisor/initscripts/master/centos-systemd-etcs" target="_blank" rel="external">centos-systemd-etcs</a>就是我们需要的CentOS 7下面的脚本。</p>
<p>建议直接复制脚本内容，然后添加到目录/etc/systemd/system下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/systemd/system/supervisord.service</div></pre></td></tr></table></figure>
<p>按键盘i建进入编辑模式，粘贴脚本内容后按键盘Esc键退出编辑模式，输入:wq回车，保存并退出。<br>然后运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="built_in">enable</span> supervisord.service</div></pre></td></tr></table></figure>
<p>就完成了supervisor的开机启动，到此Shadowsocks已经在CentOS 7 x64下安装配置成功，运行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">reboot</div></pre></td></tr></table></figure>
<p>重启服务器使服务生效，此时已经可以正常使用Shadowsocks服务。</p>
<h2 id="Shadowsocks服务优化"><a href="#Shadowsocks服务优化" class="headerlink" title="Shadowsocks服务优化"></a>Shadowsocks服务优化</h2><h3 id="系统层面"><a href="#系统层面" class="headerlink" title="系统层面"></a>系统层面</h3><p>基于kvm架构vps的优化(DO的主机正好可以用)</p>
<h4 id="优化内核参数"><a href="#优化内核参数" class="headerlink" title="优化内核参数"></a>优化内核参数</h4><p><code>vi /etc/sysctl.conf</code>直接把以下内容复制粘贴进去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"># max open files</div><div class="line">fs.file-max = 1024000</div><div class="line"># max read buffer</div><div class="line">net.core.rmem_max = 67108864</div><div class="line"># max write buffer</div><div class="line">net.core.wmem_max = 67108864</div><div class="line"># default read buffer</div><div class="line">net.core.rmem_default = 65536</div><div class="line"># default write buffer</div><div class="line">net.core.wmem_default = 65536</div><div class="line"># max processor input queue</div><div class="line">net.core.netdev_max_backlog = 4096</div><div class="line"># max backlog</div><div class="line">net.core.somaxconn = 4096</div><div class="line"></div><div class="line"># resist SYN flood attacks</div><div class="line">net.ipv4.tcp_syncookies = 1</div><div class="line"># reuse timewait sockets when safe</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line"># turn off fast timewait sockets recycling</div><div class="line">net.ipv4.tcp_tw_recycle = 0</div><div class="line"># short FIN timeout</div><div class="line">net.ipv4.tcp_fin_timeout = 30</div><div class="line"># short keepalive time</div><div class="line">net.ipv4.tcp_keepalive_time = 1200</div><div class="line"># outbound port range</div><div class="line">net.ipv4.ip_local_port_range = 10000 65000</div><div class="line"># max SYN backlog</div><div class="line">net.ipv4.tcp_max_syn_backlog = 4096</div><div class="line"># max timewait sockets held by system simultaneously</div><div class="line">net.ipv4.tcp_max_tw_buckets = 5000</div><div class="line"># TCP receive buffer</div><div class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</div><div class="line"># TCP write buffer</div><div class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</div><div class="line"># turn on path MTU discovery</div><div class="line">net.ipv4.tcp_mtu_probing = 1</div></pre></td></tr></table></figure>
<p>保存生效<code>sysctl -p</code></p>
<hr>
<h4 id="TCP优化"><a href="#TCP优化" class="headerlink" title="TCP优化"></a>TCP优化</h4><p>1.修改文件句柄数限制<br>ubuntu/centos均可修改<code>/etc/sysctl.conf</code><br>找到<code>fs.file-max</code>这一行，修改其值为<code>1024000</code>，并保存退出。然后执行<code>sysctl -p</code>使其生效<br>修改<code>vi /etc/security/limits.conf</code>文件，加入  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">*               soft    nofile           512000</div><div class="line">*               hard    nofile          1024000</div></pre></td></tr></table></figure>
<p>针对centos,还需要修改<code>vi /etc/pam.d/common-session</code>文件，加入<br><code>session required pam_limits.so</code>  </p>
<p>2.修改<code>vi /etc/profile</code>文件，加入<br><code>ulimit -SHn 1024000</code><br>然后重启服务器执行<code>ulimit -n</code>，查询返回1024000即可。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sysctl.conf报错解决方法</div><div class="line">修复modprobe的：</div><div class="line">rm -f /sbin/modprobe </div><div class="line">ln -s /bin/true /sbin/modprobe</div><div class="line">修复sysctl的：</div><div class="line">rm -f /sbin/sysctl </div><div class="line">ln -s /bin/true /sbin/sysctl</div></pre></td></tr></table></figure>
<hr>
<p><del>#### 锐速</del><br>锐速官方已不再维护免费版本，目前破解版支持的内核太旧，放弃。</p>
<hr>
<h4 id="开启TCP-Fast-Open"><a href="#开启TCP-Fast-Open" class="headerlink" title="开启TCP Fast Open"></a>开启TCP Fast Open</h4><p>这个前提条件是需要服务器是Linux 3.7+的内核，如果满足条件，那就在服务端的<code>vi /etc/sysctl.conf</code>文件中再加上一行。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># turn on TCP Fast Open on both client and server side</div><div class="line">net.ipv4.tcp_fastopen = 3</div></pre></td></tr></table></figure>
<p>然后记得把<code>vi /etc/shadowsocks.json</code>配置文件中”fast_open”:配置为true。这样速度也将会有非常显著的提升。</p>
<hr>
<h4 id="开启TCP-BBR拥塞控制算法"><a href="#开启TCP-BBR拥塞控制算法" class="headerlink" title="开启TCP BBR拥塞控制算法"></a>开启TCP BBR拥塞控制算法</h4><p>BBR 目的是要尽量跑满带宽, 并且尽量不要有排队的情况, 效果并不比速锐差<br>Linux kernel 4.9 已支持 tcp_bbr 下面简单讲述如何开启</p>
<ul>
<li>下载更换内核<br>最新内核查看<a href="http://elrepo.org/linux/kernel/el7/x86_64/RPMS/" target="_blank" rel="external">这里</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</div><div class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</div><div class="line">yum --enablerepo=elrepo-kernel install kernel-ml -y</div></pre></td></tr></table></figure>
<ul>
<li>查看内核是否安装成功</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm -qa | grep kernel</div></pre></td></tr></table></figure>
<ul>
<li>更新 grub 系统引导文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/default/grub</div></pre></td></tr></table></figure>
<p>修改对应的字段为 GRUB_DEFAULT=0，然后重新编译启动项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</div></pre></td></tr></table></figure>
<ul>
<li>删除旧内核(可选)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum remove kernel</div></pre></td></tr></table></figure>
<p>最后重启<code>reboot</code>生效。</p>
<ul>
<li><p>注意，某些服务商可能需要首先将VPS配置为可自定义内核，然后grub2的配置才会生效。</p>
</li>
<li><p>开启bbr</p>
</li>
</ul>
<p>开机后 <code>uname -r</code>  看看内核是不是最新的，至少要大于4.9  </p>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"net.core.default_qdisc=fq"</span> &gt;&gt; /etc/sysctl.conf</div><div class="line"><span class="built_in">echo</span> <span class="string">"net.ipv4.tcp_congestion_control=bbr"</span> &gt;&gt; /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>保存生效<br><code>sysctl -p</code>  </p>
<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sysctl net.ipv4.tcp_available_congestion_control</div><div class="line">sysctl net.ipv4.tcp_congestion_control</div></pre></td></tr></table></figure>
<p>如果结果都有<code>bbr</code>, 则证明你的内核已开启bbr  </p>
<p>执行<br><code>lsmod | grep bbr</code><br>看到有 tcp_bbr 模块即说明bbr已启动  </p>
<hr>
<h3 id="加密层面"><a href="#加密层面" class="headerlink" title="加密层面"></a>加密层面</h3><h4 id="安装M2Crypto"><a href="#安装M2Crypto" class="headerlink" title="安装M2Crypto"></a>安装M2Crypto</h4><p>这个可以提高SS的加密速度，安装办法:<br>先安装依赖包：<br><code>yum install -y openssl-devel gcc swig python-devel autoconf libtool</code><br>安装setuptools:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget --no-check-certificate https://raw.githubusercontent.com/iMeiji/shadowsocks_install/master/ez_setup.py</div><div class="line">python ez_setup.py install</div></pre></td></tr></table></figure>
<p>再通过pip安装M2Crypto:<br><code>pip install M2Crypto</code><br>或者<code>pip install M2Crypto --upgrade</code>  </p>
<hr>
<h4 id="2-2-安装-gevent"><a href="#2-2-安装-gevent" class="headerlink" title="2.2 安装 gevent"></a>2.2 安装 gevent</h4><p>安装 gevent可以提高 Shadowsocks 的性能。</p>
<p>CentOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install -y libevent</div><div class="line">pip install greenlet</div><div class="line">pip install gevent</div></pre></td></tr></table></figure>
<hr>
<h4 id="使用CHACHA20加密算法"><a href="#使用CHACHA20加密算法" class="headerlink" title="使用CHACHA20加密算法"></a>使用CHACHA20加密算法</h4><p>首先，安装libsodium，让系统支持chacha20算法。</p>
<p>CentOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">yum groupinstall &quot;Development Tools&quot;</div><div class="line">wget https://download.libsodium.org/libsodium/releases/LATEST.tar.gz</div><div class="line">tar zxf LATEST.tar.gz</div><div class="line">cd libsodium* </div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div><div class="line">vi /etc/ld.so.conf</div><div class="line">添加一行：</div><div class="line">/usr/local/lib</div><div class="line">保存退出后，运行命令：</div><div class="line">ldconfig</div></pre></td></tr></table></figure>
<p>然后修改ss加密方式:<br><code>vi /etc/shadowsocks.json</code><br>“method”:”aes-256-cfb”改成”method”:”chacha20”.</p>
<hr>
<h3 id="网络层面"><a href="#网络层面" class="headerlink" title="网络层面"></a>网络层面</h3><p>此外，选择合适的端口也能优化梯子的速度，广大SS用户的实践经验表明，检查站（GFW）存在一种机制来降低自身的运算压力，即常用的协议端口（如http，smtp，ssh，https，ftp等）的检查较少，所以建议SS绑定这些常用的端口（如：21，22，25，80，443），速度也会有显著提升。<br>如果你还要给小伙伴爬，那我建议开启多个端口而不是共用，这样网络会更加顺畅。  </p>
<h4 id="防火墙设置（如有）"><a href="#防火墙设置（如有）" class="headerlink" title="防火墙设置（如有）"></a>防火墙设置（如有）</h4><p>自动调整MTU<br><code>iptables -I FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</code> </p>
<p>开启 NAT （记得把 eth0 改成自己的网卡名）<br><code>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</code>  </p>
<p>开启 IPv4 的转发<br><code>sysctl -w net.ipv4.ip_forward=1</code>  </p>
<p>打开 443 端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT -p tcp --dport 443 -j ACCEPT</div><div class="line">iptables -I INPUT -p udp --dport 443 -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>重启防火墙iptables：<br><code>service iptables restart</code>  </p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>至此，这几天配置shadowsocks的过程便结束了，这里只是将我遇到的情况加以记录，并不能涵盖所有情况，如果碰到其他状况，那么<code>google</code>就好了。</p>
<p>:P</p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        

        
        <b>Copyright:</b> 转载请注明来源，本文固定链接：<a href="/post/VPS搭建Shadowsocks服务和优化笔记/" target="_blank" rel="external">https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/</a>
        
    </div>
    <footer>
        <a href="https://i-square.github.io">
            <img src="/img/avatar.jpg" alt="平方君">
            平方君
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shadowsocks/">Shadowsocks</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VPS/">VPS</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/&title=《VPS搭建Shadowsocks服务和优化笔记》 — 平方君的后花园&pic=https://i-square.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/&title=《VPS搭建Shadowsocks服务和优化笔记》 — 平方君的后花园&source=前言由于最近开始上Github较多，无意中发现Github推出了一个学生开发者优惠大礼包，这对于囊中羞涩的学生来说真的是大大的福利，给Github一个大大..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《VPS搭建Shadowsocks服务和优化笔记》 — 平方君的后花园&url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/&via=https://i-square.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/post/增强VPS安全性的常用方法/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">增强VPS安全性的常用方法</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/post/新的起点/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">新的起点</h4>
      </a>
    </div>
  
</nav>



    













<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'i-square',
            repo: 'i-square.github.io',
            oauth: {
                client_id: '62261636c7581c94e991',
                client_secret: '9c9a8b500e79af2557b97c91d831f2855871ad38',
            },
        })
        gitment.render('comments')
    </script>
</section>




</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>平方君 &copy; 2017 - 2018</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/&title=《VPS搭建Shadowsocks服务和优化笔记》 — 平方君的后花园&pic=https://i-square.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/&title=《VPS搭建Shadowsocks服务和优化笔记》 — 平方君的后花园&source=前言由于最近开始上Github较多，无意中发现Github推出了一个学生开发者优惠大礼包，这对于囊中羞涩的学生来说真的是大大的福利，给Github一个大大..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《VPS搭建Shadowsocks服务和优化笔记》 — 平方君的后花园&url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/&via=https://i-square.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://i-square.github.io/post/VPS搭建Shadowsocks服务和优化笔记/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACs0lEQVR42u3aQY7iQAwFUO5/6Z7ttHqA/13lFiO9rFBCSL0sysb24xEfX38dz8633/n5/eTqY+PAw8PDO1h6/uBnj2yX+PrM68/Jy8XDw8Pb4z3bUZOfTnbj1wEmDz/5mvHw8PA+jZenuUmQSMIDHh4e3v/La+9NNv02HcfDw8P7BN75T+e8WZBYr7Xg4eHhxby8i/Q5n1f6e3h4eHjHXfV8E88LtXnra7bCb0/Hw8PDW+DNSrGz0ur5gMJsnXh4eHgbvNnf/tmgwMkIQv4LeHh4eHu8tvSZU4+27/KJUesLDw8Pb4F3t2XVFmGL4kIeYPDw8PAWeLPFtUtpx7DaxlvRu8PDw8NbGCPIA0CbiCfNs1lpoxi9wsPDw7vEy1v4+SJmTbL2THQVDw8P7yqvbeEnG/qsbXaSTL8pQ+Dh4eFd5c3aYHmoaF9EOy4QJfp4eHh4C7y76XXb3GrBeTkDDw8Pb5s329ATTF6YuHWmmE3Aw8PDG/HyR+blhlmCnif3RWcPDw8Pb4E3KzS0bbB8QKFN9JMkGw8PD2+Dl6TIJ0l5O0BwMpKFh4eH9/u8kzZ/G1pmKXWyBjw8PLwN3t6yzgez2mGvf1zFw8PDW+PdbU0lye6sGFGPHeDh4eEt8E4aS0n6244gtPXmug2Gh4eHd4l3KzDkzao8dW6Lv9E7xsPDw1vgFTeXpdWkbDEbIygCAx4eHt4y72TLnrXZ2pf7JhHHw8PDu8r7Ko/2kUnIyYNE3YrDw8PDW+C1yfHJGEGbZM8+Dw88PDy8kjcLBietslt3Rck6Hh4e3hovLxzMXkHbDLtV4MDDw8P7HF7bvsoDQzJ6VQyB4eHh4X0ALwkPCeB8bCsq2uLh4eGt8fIFzVpQySjVLFS8oeLh4eEt8No//G3D7GSgqig6nPf38PDw8N7f+wc2ZA0BuTgpYQAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };



</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
