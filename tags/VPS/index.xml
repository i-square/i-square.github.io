<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>VPS on 平方君的后花园</title><link>https://i-square.github.io/tags/VPS/</link><description>Recent content in VPS on 平方君的后花园</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 06 Mar 2017 09:24:30 +0000</lastBuildDate><atom:link href="https://i-square.github.io/tags/VPS/index.xml" rel="self" type="application/rss+xml"/><item><title>增强VPS安全性的常用方法</title><link>https://i-square.github.io/p/Common-Ways-to-Enhance-VPS-Security/</link><pubDate>Mon, 06 Mar 2017 09:24:30 +0000</pubDate><guid>https://i-square.github.io/p/Common-Ways-to-Enhance-VPS-Security/</guid><description>&lt;h2 id="前言">前言&lt;/h2>
&lt;p>因为之前提到的Gihub学生包，我入手了 &lt;code>DigitalOcean&lt;/code> 的VPS，由于刚刚接触VPS，对于VPS的安全性并没有什么概念，所以我直接使用一个汉化版PuTTY客户端，以root账户在22端口登录的，刚开始登录几次都没出现什么状况，然而隔天登录的时候就出现了类似以下的提示，这才让我产生了要提高VPS安全性的想法。&lt;/p>
&lt;!-- more -->
&lt;blockquote>
&lt;p>Last failed login: Tue Feb 10 23:32:08 EST 2017 from static-15-64-34.rpnspl.com on ssh:notty
There were 166 failed login attempts since the last successful login.
Last login: Tue Feb 10 18:54:37 2017 from &lt;code>ip&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>这里的 &lt;code>ip&lt;/code> 并不是我的IP地址，也就是说有人(或机器人)在恶意试探我的VPS密码。看到这提示，我马上上谷歌搜索，发现这个现象非常普遍，多数都是被机器人扫描然后试图暴力破解，如果不加以防范，代价会很大。&lt;/p>
&lt;p>我在查问题的时候发现，PuTTY官方并没有提供中文版本，所以网上的汉化版有可能被植入后门，非常不安全，所以在此提醒，这一类涉及重要密码的软件&lt;strong>绝对不要&lt;/strong>用民间汉化版！&lt;/p>
&lt;p>那么如何知道自己的VPS账号正在遭受扫描和暴力破解呢？简单的方法就是查看日志：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看登录成功的用户信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">last
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 最新的登录记录在最前面，所以可以用以下命令来查看。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">last &lt;span class="p">|&lt;/span> less
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看登录失败的用户信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lastb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看登录日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tail /var/log/secure
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>也可以执行以下命令，查询出来的结果中包含了&lt;code>ip地址=数量&lt;/code>就是攻击者信息。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cat /var/log/secure&lt;span class="p">|&lt;/span>awk &lt;span class="s1">&amp;#39;/Failed/{print $(NF-3)}&amp;#39;&lt;/span>&lt;span class="p">|&lt;/span>sort&lt;span class="p">|&lt;/span>uniq -c&lt;span class="p">|&lt;/span>awk &lt;span class="s1">&amp;#39;{print $2&amp;#34;=&amp;#34;$1;}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如何来增强VPS账号的安全性呢？除了养成使用正规软件的好习惯外，还要从VPS本身来加强VPS账号的安全性。&lt;/p>
&lt;ul>
&lt;li>Linux有一个自动统计VPS登录错误的工具： &lt;code>Denyhosts&lt;/code> ，一旦登录VPS账号错误次数超过了 &lt;code>Denyhosts&lt;/code> 的安全设置， &lt;code>Denyhosts&lt;/code> 就会将该IP记录下来，同时将其放入黑名单当中，禁止该IP在某一段时间内继续访问VPS，通过它可以实现自动封锁恶意IP&lt;/li>
&lt;li>默认的SSH端口是22，通过修改自己的SSH端口先为扫描者增加一道端口门槛&lt;/li>
&lt;li>VPS默认的账号是root，如果我们禁用了root，那么要攻破账号又得先暴力猜测VPS的账号，难度又增加几分&lt;/li>
&lt;li>如果还不放心，我们可以直接禁用密码登录验证VPS的方式，改用密钥登录，这样安全系数是相当高了&lt;/li>
&lt;/ul>
&lt;p>&lt;em>注：本人主机为CentOS 7 x64系统，以下内容均基于此环境&lt;/em>&lt;/p>
&lt;h2 id="denyhosts攻击">Denyhosts攻击&lt;/h2>
&lt;ol>
&lt;li>Linux各平台现在基本上都可以直接安装Denyhosts了，直接运行命令安装&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">yum install denyhosts
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>
&lt;p>安装好了Denyhosts，默认的配置基本上就可以防御一定的暴力攻击了， &lt;code>/etc/hosts.deny&lt;/code> 文件里保存了被屏蔽的记录。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如果你要自定义Denyhosts的相关配置，执行： &lt;code>vi /etc/denyhosts.conf&lt;/code> ，相关参数的说明可以自行搜索，一般用户默认即可。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="修改ssh端口">修改SSH端口&lt;/h2>
&lt;p>输入命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">vi /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编辑SSH服务的配置文件，找到 &lt;code>#port 22&lt;/code> ，将前面的 &lt;code>#&lt;/code> 去掉，然后将 &lt;code>22&lt;/code> 修改为你自己设定的端口号，如 &lt;code>12345&lt;/code> ，保存后重启SSH服务以使配置生效&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">systemctl restart sshd.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="禁用root账户">禁用Root账户&lt;/h2>
&lt;p>禁用root账户之前，必须先新建一个新的账户。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">useradd user &lt;span class="c1">#添加用户名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">passwd user &lt;span class="c1">#为user用户设置密码&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后编辑配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">vi /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>找到里面的 &lt;code>PermitRootLogin yes&lt;/code> ，将后面的 &lt;code>yes&lt;/code> 改成 &lt;code>no&lt;/code> ，如果没有这一行则直接加入即可。保存后重启SSH服务以使配置生效&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">systemctl restart sshd.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="使用密钥登录">使用密钥登录&lt;/h2>
&lt;h3 id="生成密钥">生成密钥&lt;/h3>
&lt;p>SSH登录方式有账号+密码和密钥认证两种形式，为了阻止暴力破解VPS的账号和密码，我们可以放弃密码验证的方式，改用密钥文件验证。&lt;/p>
&lt;p>以&lt;strong>普通用户&lt;/strong>(如user)执行以下命令，在VPS上生成密钥文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ssh-keygen -t rsa
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>生成密钥时会询问你密钥保存的位置，默认是 &lt;code>/username/.ssh&lt;/code> ，保持默认即可，你还可以为你的密钥设置一个密码，默认为空。&lt;/p>
&lt;p>密钥生成后，进入密钥存放的目录中，执行以下命令，将公钥生成一个新的文件。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cat id_rsa.pub &amp;gt;&amp;gt; authorized_keys
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>将id-rsa这个私钥文件用winSCP下载到本地，打开PuTTYGen软件，执行Conversions-&amp;gt;Import Key，导入这个私钥文件，然后选择Save private key，这时会在本地生成一个PPK文件，在PuTTY的 &lt;code>Connection/SSH/Auth&lt;/code> 中选择刚刚保存的PPK文件，以后即可用密钥认证登录VPS了。&lt;/p>
&lt;h3 id="centos-7权限问题">CentOS 7权限问题&lt;/h3>
&lt;p>CentOS 7系统下，用户user的home目录： &lt;code>/home/user&lt;/code> 的权限变成了 &lt;code>777&lt;/code> ，造成不能正常登陆SSH，报如下错误： &lt;code>Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password)&lt;/code>&lt;/p>
&lt;p>SSH对公钥、私钥的权限和所有权的要求是非常严格的，总结如下：
1、下面两个目录的所有权必须是 &lt;code>user&lt;/code> ，所属组也应该是 &lt;code>user&lt;/code> ，权限必须为 &lt;code>700&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>/home/user
/home/user/.ssh&lt;/p>
&lt;/blockquote>
&lt;p>2、下面公钥文件的所有权必须是 &lt;code>user&lt;/code> ，所属组也应该是 &lt;code>user&lt;/code> ，权限必须为 &lt;code>644&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>/home/user/.ssh/authorized_keys&lt;/p>
&lt;/blockquote>
&lt;p>3、下面私钥文件的所有权必须是 &lt;code>user&lt;/code> ，所属组也应该是 &lt;code>user&lt;/code> ，权限必须是 &lt;code>600&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>/home/user/.ssh/id_rsa&lt;/p>
&lt;/blockquote>
&lt;p>接着上面的操作，这次需要获取root权限，首先输入命令 &lt;code>su&lt;/code> 再输入root密码获取root权限，然后依次执行以下命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir /etc/ssh/user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /home/user/.ssh/authorized_keys /etc/ssh/user/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">755&lt;/span> /etc/ssh/user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> /etc/ssh/user/authorized_keys
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chown -R user:user /etc/ssh/user
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编辑SSH配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">vi /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>找到 &lt;code>AuthorizedKeysFile&lt;/code> 这项(如果没有则添加)，修改为&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">AuthorizedKeysFile /etc/ssh/%u/authorized_keys
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>保存后重启SSH服务以使配置生效&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">systemctl restart sshd.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="禁止密码登录">禁止密码登录&lt;/h3>
&lt;p>&lt;strong>注意：请确认你已经可以通过密钥认证的方式登录VPS&lt;/strong>&lt;/p>
&lt;p>有了密钥登录VPS，我们就可以禁止用密码登录这种验证方式了，还是
编辑SSH配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">vi /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>找到 &lt;code>PasswordAuthentication&lt;/code> (没有则添加)并修改后面的 &lt;code>yes&lt;/code> 为 &lt;code>no&lt;/code> ，保存后重启SSH服务以使配置生效&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">systemctl restart sshd.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="小结">小结&lt;/h2>
&lt;p>通过以上这些措施可以有效防范暴力破解VPS，平时使用官方软件也是提升安全性的一大举措，总而言之，没有绝对的安全，但是只要我们平时稍加留心就不会给破解者可乘之机。&lt;/p></description></item></channel></rss>