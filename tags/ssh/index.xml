<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ssh on 平方君的后花园</title><link>https://i-square.github.io/tags/ssh/</link><description>Recent content in Ssh on 平方君的后花园</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 18 Mar 2022 17:34:07 +0800</lastBuildDate><atom:link href="https://i-square.github.io/tags/ssh/index.xml" rel="self" type="application/rss+xml"/><item><title>使用expect脚本一键登录跳板机</title><link>https://i-square.github.io/p/login-to-the-springboard-machine-easily-by-expect-script/</link><pubDate>Fri, 18 Mar 2022 17:34:07 +0800</pubDate><guid>https://i-square.github.io/p/login-to-the-springboard-machine-easily-by-expect-script/</guid><description>&lt;img src="https://i-square.github.io/p/login-to-the-springboard-machine-easily-by-expect-script/login.svg" alt="Featured image of post 使用expect脚本一键登录跳板机" />&lt;h2 id="背景">背景&lt;/h2>
&lt;p>为了安全，多数公司会采用跳板机的方式访问内网服务器，登录需要输入AD密码和谷歌验证码，非常繁琐，这里提供一个基于expect脚本的方法，实现一键登录跳板机&lt;/p>
&lt;blockquote>
&lt;p>注：笔者在 MacOS 和 Ubuntu20.04 环境下测试ok，其他环境大同小异，按需修改即可。&lt;/p>
&lt;/blockquote>
&lt;h2 id="方法">方法&lt;/h2>
&lt;p>此方式思路是利用expect脚本交互式输入预设的AD密码，输入实时获取的谷歌验证码（使用 python authenticator 工具）&lt;/p>
&lt;h3 id="所需依赖">所需依赖&lt;/h3>
&lt;p>安装以下工具，各平台安装方法请自行搜索：&lt;/p>
&lt;ul>
&lt;li>expect&lt;/li>
&lt;li>python&lt;/li>
&lt;li>pip&lt;/li>
&lt;li>authenticator&lt;/li>
&lt;/ul>
&lt;h2 id="authenticator配置">authenticator配置&lt;/h2>
&lt;h3 id="安装">安装&lt;/h3>
&lt;p>&lt;code>pip install authenticator&lt;/code> 若不成功，请先升级pip到最新版本&lt;/p>
&lt;h3 id="配置">配置&lt;/h3>
&lt;ol>
&lt;li>执行 &lt;code>authenticator add $user&lt;/code>（AD账号无邮箱后缀）&lt;/li>
&lt;li>提示 &lt;code>Enter passphrase&lt;/code> 这里输入2次AD密码&lt;/li>
&lt;li>提示 &lt;code>Enter shared secret&lt;/code> 需要把谷歌验证码的字符串输入到这里&lt;/li>
&lt;li>到这里就配置ok了，执行 &lt;code>authenticator generate&lt;/code> ，输入AD密码，看到谷歌验证码正常输出就是成功了&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>配置完成之后就可以使用expect脚本来自动登录了&lt;/p>
&lt;/blockquote>
&lt;h3 id="注意点">注意点&lt;/h3>
&lt;p>多数公司的AD密码可能需要每隔一段时间更新一次，在更新AD密码后，使用 &lt;code>authenticator&lt;/code> 仍然需要输入旧密码，所以下述脚本内相应的做了一下兼容&lt;/p>
&lt;h2 id="expect脚本">expect脚本&lt;/h2>
&lt;h3 id="脚本">脚本&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/expect
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> timeout &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> USERNAME xxx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> PASSWORD_GEN xxxx &lt;span class="c1"># 首次配置 authenticator 时使用的密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> PASSWORD xxxxxxxx &lt;span class="c1"># AD密码，每隔 xx 天更新一次&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> JUMP_ZONE zone &lt;span class="c1"># 假如跳板机区分区域&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> LINK_TYPE ssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> DOMAIN example.com &lt;span class="c1"># 登录域名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 判断是否是 vscode 云端环境&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="nv">$JUMP_ZONE&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;vscode&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">set&lt;/span> main_response &lt;span class="s2">&amp;#34;Opt&amp;gt;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">set&lt;/span> main_response &lt;span class="s2">&amp;#34;Ip:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spawn authenticator generate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="s2">&amp;#34;passphrase:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PASSWORD_GEN&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="s2">&amp;#34;seconds&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> found &lt;span class="o">[&lt;/span>regexp &lt;span class="o">{([&lt;/span>0-9&lt;span class="o">]{&lt;/span>6&lt;span class="o">})}&lt;/span> &lt;span class="nv">$expect_out&lt;/span>&lt;span class="o">(&lt;/span>buffer&lt;span class="o">)&lt;/span> match verify_code&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="nv">$found&lt;/span> &lt;span class="o">==&lt;/span> 1&lt;span class="o">}&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> send &lt;span class="se">\x&lt;/span>&lt;span class="m">03&lt;/span> &lt;span class="c1"># 发送 Ctrl-C 结束 authenticator 进程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> puts &lt;span class="s2">&amp;#34;invalid verification code&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spawn &lt;span class="si">${&lt;/span>&lt;span class="nv">LINK_TYPE&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">USERNAME&lt;/span>&lt;span class="si">}&lt;/span>@jump-&lt;span class="si">${&lt;/span>&lt;span class="nv">JUMP_ZONE&lt;/span>&lt;span class="si">}&lt;/span>.&lt;span class="si">${&lt;/span>&lt;span class="nv">DOMAIN&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expect &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;yes/no&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span> send &lt;span class="s2">&amp;#34;yes\r&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> exp_continue &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Verification code:&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span> send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$verify_code&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> exp_continue &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;assword:&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span> send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PASSWORD&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> exp_continue &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;MFA auth&amp;#34;&lt;/span> &lt;span class="o">{&lt;/span> send &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$verify_code&lt;/span>&lt;span class="s2">\r&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> exp_continue &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$main_response&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interact
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="使用">使用&lt;/h3>
&lt;ol>
&lt;li>把脚本开头的几个变量设置一下，或者自己修改为从argv里读取
&lt;ul>
&lt;li>&lt;code>USERNAME&lt;/code> AD账户不带邮箱后缀&lt;/li>
&lt;li>&lt;code>PASSWORD&lt;/code> AD密码&lt;/li>
&lt;li>&lt;code>JUMP_ZONE&lt;/code> 是跳板机的区域代码，按需&lt;/li>
&lt;li>&lt;code>LINK_TYPE&lt;/code> 是连接协议，比如 &lt;code>ssh | sftp&lt;/code>，按需&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>假设保存文件为 &lt;code>~/jump_ssh.exp&lt;/code>&lt;/li>
&lt;li>执行脚本即可自动化登录到跳板机 &lt;code>expect ~/jump_ssh.exp&lt;/code>
&lt;ol>
&lt;li>也可以给脚本加上可执行权限 &lt;code>chmod a+x ~/jump_ssh.exp&lt;/code>&lt;/li>
&lt;li>然后直接执行即可 &lt;code>~/jump_ssh.exp&lt;/code>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol></description></item></channel></rss>